# .taskfiles/Bootstrap/Taskfile.yaml
---
version: "3"

vars:
  ANSIBLE_PLAYBOOK_DIR: "{{.ROOT_DIR}}/ansible/playbooks"
  BOOTSTRAP_DIR: "{{.ROOT_DIR}}/bootstrap"
  KUBERNETES_DIR: "{{.ROOT_DIR}}/kubernetes"

tasks:
  os:
    desc: Prepare os
    cmds:
    - ansible-playbook {{.ANSIBLE_PLAYBOOK_DIR}}/prepare.yaml

  k8s:
    desc: Install Kubernetes
    cmds:
    - ansible-playbook {{.ANSIBLE_PLAYBOOK_DIR}}/install.yaml

  wait:
    desc: Wait for nodes to be not-ready
    cmds:
    - |
      until kubectl get nodes &>/dev/null; do
          echo "Nodes not available yet, waiting... Retrying in 5 seconds..."
          sleep 5
      done
      until ! kubectl wait nodes --for=condition=Ready --all --timeout=1s &>/dev/null; do
          echo "Waiting for nodes to be registered but not ready... Retrying in 5 seconds..."
          sleep 5
      done
      echo "Nodes are up and not ready, proceeding with bootstrap..."

  namespaces:
    desc: Apply kubernetes namespaces
    cmds:
    - |
      find "{{.KUBERNETES_DIR}}/apps" -mindepth 1 -maxdepth 1 -type d | while IFS= read -r dir; do
          if ! kustomize build "$dir" | yq ea -e 'select(.kind == "Namespace")' | kubectl apply --server-side --field-manager bootstrap --force-conflicts -f -; then
              task: :log
                vars:
                  level: "fatal"
                  msg: "Failed to apply namespace"
                  args: "stage=namespaces namespace=$(basename "$dir")"
          fi
      done

  resources:
    desc: Apply Kubernetes resources
    cmds:
    - |
      task template file="{{.BOOTSTRAP_DIR}}/resources.yaml.j2" | kubectl apply --server-side --field-manager bootstrap --force-conflicts -f -;

  crds:
    desc: Apply helmfile crds
    cmds:
    - helmfile -f "{{.BOOTSTRAP_DIR}}/helmfile.d/00-crds.yaml" template -q | kubectl apply --server-side --field-manager bootstrap --force-conflicts -f -;

  apps:
    desc: Apply helmfile apps
    cmds:
    - helmfile -f "{{.BOOTSTRAP_DIR}}/helmfile.d/01-apps.yaml" sync --hide-notes

  template:
    internal: true
    cmds:
    - minijinja-cli "{{.file}}" {{.args}} | op inject
