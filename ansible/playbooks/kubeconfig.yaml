---
- name: Download kubeconfig
  hosts: controller
  any_errors_fatal: true
  become: true
  gather_facts: true

  tasks:
    - name: Get absolute path to this Git repository
      ansible.builtin.command: git rev-parse --show-toplevel
      delegate_to: localhost
      become: false
      register: repository_path
      changed_when: false
      check_mode: false
      failed_when: repository_path.rc != 0
      when: inventory_hostname == k3s_primary_control_node

    - name: Check if kubeconfig exists on remote
      ansible.builtin.stat:
        path: /etc/rancher/k3s/k3s.yaml
      register: remote_kubeconfig
      when: inventory_hostname == k3s_primary_control_node

    - name: Fail if kubeconfig not found
      ansible.builtin.fail:
        msg: "Kubeconfig not found at /etc/rancher/k3s/k3s.yaml. Is K3s installed?"
      when:
        - inventory_hostname == k3s_primary_control_node
        - not remote_kubeconfig.stat.exists

    - name: Copy kubeconfig to the project directory
      ansible.builtin.fetch:
        src: /etc/rancher/k3s/k3s.yaml
        dest: "{{ repository_path.stdout }}/kubeconfig"
        flat: true
        mode: "0600"
      when: inventory_hostname == k3s_primary_control_node

    - name: Update kubeconfig with correct settings
      delegate_to: localhost
      become: false
      ansible.builtin.shell: |
        set -o pipefail
        yq eval -i '
          .clusters[0].name = "homelab" |
          .clusters[0].cluster.server = "https://{{ k3s_registration_address }}:6443" |
          .contexts[0].name = "homelab" |
          .contexts[0].context.cluster = "homelab" |
          .current-context = "homelab"
        ' "{{ repository_path.stdout }}/kubeconfig"
      register: kubeconfig_update
      changed_when: kubeconfig_update.rc == 0
      when: inventory_hostname == k3s_primary_control_node

    - name: Set proper file permissions
      delegate_to: localhost
      become: false
      ansible.builtin.file:
        path: "{{ repository_path.stdout }}/kubeconfig"
        mode: "0600"
      when: inventory_hostname == k3s_primary_control_node
